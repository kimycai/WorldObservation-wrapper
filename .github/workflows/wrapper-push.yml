name: Build wrapper & Push all artifacts to wrapper-build
# 纯手动触发，无自动执行逻辑
on:
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：拉取原 wrapper 源码（待编译项目）
      - name: Checkout wrapper source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：安装原生构建工具依赖（1:1匹配原生要求）
      - name: Install build tools
        run: |
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y build-essential cmake wget unzip git

      # 步骤3：安装LLVM（复用原生一键安装脚本）
      - name: Install LLVM
        run: sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)"

      # 步骤4：下载并解压Android NDK r23b（匹配原生路径，静默操作）
      - name: Download & extract Android NDK r23b
        run: |
          wget -q -O android-ndk-r23b-linux.zip https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
          unzip -q -d ~ android-ndk-r23b-linux.zip

      # 步骤5：CMake+Make编译（保留所有产物，为可执行文件赋权）
      - name: Build wrapper (cmake + make)
        run: |
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)
          # 为目录下所有可执行文件添加执行权限（含wrapper），保留其他文件原始权限
          find . -type f -executable -exec chmod +x {} \;
          # 验证编译产物，列出所有文件/目录（方便排查）
          ls -lhR .

      # 步骤6：配置Git身份（为推送产物做准备，固定配置）
      - name: Configure Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤7：拉取 wrapper-build 仓库（产物目标仓库）
      - name: Checkout wrapper-build repository
        uses: actions/checkout@v4
        with:
          repository: kimycai/wrapper-build  # 你的「用户名/仓库名」，无需修改
          ref: main                          # 推送到main分支
          token: ${{ secrets.WRAPPER_BUILD_TOKEN }}  # 已配置的专属令牌
          path: wrapper-build                # 与原项目隔离的工作目录
          fetch-depth: 1

      # 步骤8：复制build目录所有产物到wrapper-build并推送（核心修改步骤）
      - name: Copy all build artifacts & push to wrapper-build
        run: |
          # 复制build目录下的所有文件/子目录到wrapper-build仓库根目录
          # -r 递归复制（含子目录），-p 保留文件原始权限/时间戳
          cp -rp build/* wrapper-build/
          # 进入wrapper-build仓库目录
          cd wrapper-build
          # 验证复制结果，列出所有产物（方便排查）
          ls -lhR .
          # 提交并推送所有产物（无变更则跳过，避免工作流失败）
          git add .
          git commit -m "Update all wrapper build artifacts $(date +%Y%m%d_%H%M%S)" || echo "No changes to commit"
          git push origin main
