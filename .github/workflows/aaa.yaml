name: Build wrapper from Source (Ubuntu 24.04)
# 仅手动触发，无任何自动执行规则
on:
  workflow_dispatch:

jobs:
  build:
    # 固定运行环境为 Ubuntu 24.04
    runs-on: ubuntu-24.04
    steps:
      # 拉取外部仓库 WorldObservationLog/wrapper 源码到 wrapper/ 目录
      - name: Checkout WorldObservationLog/wrapper source code
        uses: actions/checkout@v4
        with:
          repository: WorldObservationLog/wrapper
          path: wrapper
          fetch-depth: 1

      # 安装 Ubuntu 24.04 基础构建依赖（含源适配优化）
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential cmake wget unzip git
          sudo apt update --fix-missing -y

      # 安装 LLVM 工具链（官方脚本）
      - name: Install LLVM
        run: sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)"

      # 下载并解压 Android NDK r23b 到用户主目录
      - name: Download and extract Android NDK r23b
        run: |
          wget -O android-ndk-r23b-linux.zip https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
          unzip -q -d ~ android-ndk-r23b-linux.zip

      # 配置 NDK 全局环境变量（CI 标准方式）
      - name: Set ANDROID_NDK_HOME environment variable
        run: echo "ANDROID_NDK_HOME=~/android-ndk-r23b" >> $GITHUB_ENV

      # 生成 CMake 编译配置（源码外编译，不污染源码）
      - name: Generate build files with CMake
        run: |
          cd wrapper
          mkdir -p build
          cd build
          cmake ..

      # 多核并行编译项目（使用全部 CPU 核心）
      - name: Build project with make
        run: |
          cd wrapper/build
          make -j$(nproc)


