name: aaaaBuild wrapper
on:
  workflow_dispatch:

jobs:
  build-wrapper:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：拉取wrapper源码
      - name: Checkout wrapper source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：安装原生构建工具依赖（1:1匹配要求）
      - name: Install build tools
        run: |
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y build-essential cmake wget unzip git

      # 步骤3：安装LLVM（复用原生一键脚本）
      - name: Install LLVM
        run: sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)"

      # 步骤4：下载并解压Android NDK r23b（匹配原生路径）
      - name: Download & extract Android NDK r23b
        run: |
          wget -q -O android-ndk-r23b-linux.zip https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
          unzip -q -d ~ android-ndk-r23b-linux.zip

      # 步骤5：CMake+Make编译（核心：确保产物最终为wrapper）
      - name: Build wrapper (cmake + make)
        run: |
          # 原生构建流程，兼容目录已存在情况
          mkdir -p build && cd build
          # CMake配置（指向源码根目录，原生逻辑）
          cmake ..
          # 多线程编译（自动匹配CPU核心数）
          make -j$(nproc)
          # 关键：验证产物是否为wrapper，确保命名正确
          ls -lh ./wrapper && chmod +x ./wrapper

      # 步骤6：上传产物（仅上传wrapper可执行文件，命名固定为wrapper）
      - name: Upload wrapper artifact
        uses: actions/upload-artifact@v4
        with:
          name: wrapper # 产物包名称为wrapper（下载后解压即得该文件）
          path: build/wrapper # 精准指向编译后的wrapper可执行文件
          retention-days: 90 # 产物保留90天，可修改（1-90天）
